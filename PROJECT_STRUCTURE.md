# ç‹¼äººæ€ç«æŠ€åœº - é¡¹ç›®ç»“æ„

é¡¹ç›®é‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œéµå¾ª DDD (Domain-Driven Design) å’Œ Clean Architecture åŸåˆ™ã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
werewolf_arena/
â”œâ”€â”€ bin/                         # å¯æ‰§è¡Œæ–‡ä»¶
â”‚   â””â”€â”€ werewolf_arena.dart     # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ lib/                         # Dart æºä»£ç 
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒæ¸¸æˆé€»è¾‘ (Domain Layer)
â”‚   â”‚   â”œâ”€â”€ engine/             # æ¸¸æˆå¼•æ“
â”‚   â”‚   â”‚   â”œâ”€â”€ game_engine.dart
â”‚   â”‚   â”‚   â””â”€â”€ game_engine_callbacks.dart
â”‚   â”‚   â”œâ”€â”€ state/              # æ¸¸æˆçŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ game_state.dart
â”‚   â”‚   â”‚   â””â”€â”€ game_event.dart
â”‚   â”‚   â”œâ”€â”€ rules/              # æ¸¸æˆè§„åˆ™å’Œåœºæ™¯
â”‚   â”‚   â”‚   â”œâ”€â”€ game_scenario.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ game_scenario_manager.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ scenarios_standard_12.dart
â”‚   â”‚   â”‚   â””â”€â”€ scenarios_simple_9.dart
â”‚   â”‚   â””â”€â”€ logic/              # æ¸¸æˆé€»è¾‘å¤„ç†
â”‚   â”‚       â””â”€â”€ logic_contradiction_detector.dart
â”‚   â”œâ”€â”€ entities/               # å®ä½“å±‚
â”‚   â”‚   â””â”€â”€ player/             # ç©å®¶ç›¸å…³å®ä½“
â”‚   â”‚       â”œâ”€â”€ player.dart
â”‚   â”‚       â”œâ”€â”€ ai_player.dart
â”‚   â”‚       â”œâ”€â”€ ai_personality_state.dart
â”‚   â”‚       â””â”€â”€ role.dart
â”‚   â”œâ”€â”€ infrastructure/         # åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)
â”‚   â”‚   â”œâ”€â”€ llm/               # LLM æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ llm_service.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ prompt_manager.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ enhanced_prompts.dart
â”‚   â”‚   â”‚   â””â”€â”€ json_cleaner.dart
â”‚   â”‚   â”œâ”€â”€ logging/           # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”‚   â”‚   â”œâ”€â”€ logger.dart
â”‚   â”‚   â”‚   â””â”€â”€ player_logger.dart
â”‚   â”‚   â””â”€â”€ config/            # é…ç½®ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ config.dart
â”‚   â”‚       â””â”€â”€ config_loader_old.dart
â”‚   â”œâ”€â”€ presentation/          # è¡¨ç°å±‚ (Presentation Layer)
â”‚   â”‚   â”œâ”€â”€ console/           # æ§åˆ¶å° UI
â”‚   â”‚   â”‚   â”œâ”€â”€ game_console.dart
â”‚   â”‚   â”‚   â””â”€â”€ console_callback_handler.dart
â”‚   â”‚   â””â”€â”€ cli/               # å‘½ä»¤è¡Œæ¥å£
â”‚   â”‚       â””â”€â”€ werewolf_arena.dart
â”‚   â”œâ”€â”€ shared/                # å…±äº«å·¥å…·
â”‚   â”‚   â””â”€â”€ random_helper.dart
â”‚   â””â”€â”€ werewolf_arena.dart     # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ test/                       # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ config/                     # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ *.yaml
â””â”€â”€ pubspec.yaml               # Dart é¡¹ç›®é…ç½®
```

## ğŸ—ï¸ æ¶æ„å±‚æ¬¡è¯´æ˜

### 1. Core Layer (æ ¸å¿ƒå±‚)
**èŒè´£**: çº¯ç²¹çš„æ¸¸æˆé€»è¾‘ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨ç³»ç»Ÿ
- **Engine**: æ¸¸æˆå¼•æ“ï¼Œç®¡ç†æ¸¸æˆæµç¨‹å’ŒçŠ¶æ€è½¬æ¢
- **State**: æ¸¸æˆçŠ¶æ€å’Œäº‹ä»¶å®šä¹‰
- **Rules**: æ¸¸æˆè§„åˆ™ã€åœºæ™¯å’Œæ¸¸æˆé…ç½®
- **Logic**: æ¸¸æˆé€»è¾‘å¤„ç†ï¼Œå¦‚çŸ›ç›¾æ£€æµ‹

### 2. Entities Layer (å®ä½“å±‚)
**èŒè´£**: æ¸¸æˆä¸­çš„æ ¸å¿ƒå®ä½“å¯¹è±¡
- **Player**: ç©å®¶åŸºç¡€ç±»å’Œ AI ç©å®¶
- **Role**: è§’è‰²å®šä¹‰å’Œèƒ½åŠ›
- **AI State**: AI ç©å®¶çš„çŠ¶æ€å’Œæ€§æ ¼

### 3. Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)
**èŒè´£**: å¤–éƒ¨ä¾èµ–å’ŒæŠ€æœ¯å®ç°
- **LLM**: è¯­è¨€æ¨¡å‹æœåŠ¡é›†æˆ
- **Logging**: æ—¥å¿—è®°å½•ç³»ç»Ÿ
- **Config**: é…ç½®æ–‡ä»¶ç®¡ç†

### 4. Presentation Layer (è¡¨ç°å±‚)
**èŒè´£**: ç”¨æˆ·ç•Œé¢å’Œäº¤äº’
- **Console**: æ§åˆ¶å°ç•Œé¢å’Œæ ¼å¼åŒ–è¾“å‡º
- **CLI**: å‘½ä»¤è¡Œå‚æ•°å¤„ç†å’Œåº”ç”¨å¯åŠ¨

### 5. Shared Layer (å…±äº«å±‚)
**èŒè´£**: é€šç”¨å·¥å…·å’Œè¾…åŠ©åŠŸèƒ½
- **Random Helper**: éšæœºæ•°ç”Ÿæˆå’Œè¾…åŠ©å·¥å…·

## ğŸ”— ä¾èµ–å…³ç³»

```
Presentation â†’ Core â†’ Entities
     â†“              â†“       â†“
Infrastructure â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘
   Shared
```

- **Core** ä¸ä¾èµ–ä»»ä½•å…¶ä»–å±‚çº§ï¼Œæ˜¯æœ€çº¯å‡€çš„ä¸šåŠ¡é€»è¾‘
- **Presentation** ä¾èµ– Core å’Œ Infrastructure
- **Infrastructure** æä¾›æŠ€æœ¯æ”¯æŒç»™ä¸Šå±‚
- **Entities** è¢«æ‰€æœ‰å±‚çº§å…±äº«
- **Shared** æä¾›é€šç”¨å·¥å…·

## ğŸ¯ é‡æ„ä¼˜åŠ¿

1. **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**: æ¯ä¸ªæ¨¡å—éƒ½æœ‰æ˜ç¡®çš„å•ä¸€èŒè´£
2. **é«˜å†…èšä½è€¦åˆ**: ç›¸å…³åŠŸèƒ½èšé›†åœ¨ä¸€èµ·ï¼Œæ¨¡å—é—´ä¾èµ–æœ€å°åŒ–
3. **å¯æµ‹è¯•æ€§**: æ ¸å¿ƒé€»è¾‘å¯ä»¥ç‹¬ç«‹æµ‹è¯•ï¼Œä¸ä¾èµ–å¤–éƒ¨ç³»ç»Ÿ
4. **å¯æ‰©å±•æ€§**: å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„è¡¨ç°å±‚ï¼ˆå¦‚ Web UIã€GUIï¼‰
5. **å¯ç»´æŠ¤æ€§**: ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹
6. **ä¾èµ–æ³¨å…¥**: é€šè¿‡å›è°ƒç³»ç»Ÿå®ç°æ¾è€¦åˆ

## ğŸ“¦ æ¨¡å—é€šä¿¡

- **äº‹ä»¶é©±åŠ¨**: æ¸¸æˆå¼•æ“é€šè¿‡å›è°ƒé€šçŸ¥å¤–éƒ¨äº‹ä»¶
- **ä¾èµ–æ³¨å…¥**: å›è°ƒå¤„ç†å™¨é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥
- **æ¥å£éš”ç¦»**: é€šè¿‡æ¥å£å®šä¹‰æ¨¡å—é—´çš„é€šä¿¡åè®®

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

```dart
// åˆ›å»ºæ¸¸æˆå¼•æ“
final engine = GameEngine(
  configManager: configManager,
  callbacks: consoleCallbackHandler,
);

// å¯åŠ¨æ¸¸æˆ
await engine.startGame();

// æ‰§è¡Œæ¸¸æˆæ­¥éª¤
while (!engine.isGameEnded) {
  await engine.executeGameStep();
}
```

è¿™ç§æ¶æ„ä½¿å¾—æ¸¸æˆé€»è¾‘ä¸ UI å®Œå…¨åˆ†ç¦»ï¼Œä½ å¯ä»¥è½»æ¾æ›¿æ¢ä¸åŒçš„è¡¨ç°å±‚è€Œä¸å½±å“æ ¸å¿ƒæ¸¸æˆé€»è¾‘ã€‚